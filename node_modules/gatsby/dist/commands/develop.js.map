{"version":3,"sources":["../../src/commands/develop.js"],"names":["program","directory","directoryPath","withBasePath","createIndexHtml","developHtml","catch","err","name","report","panic","stripIndent","bootstrap","webpackConfig","port","compilerConfig","devConfig","resolve","compiler","webpack","app","express","use","require","log","path","heartbeat","graphqlHTTP","schema","store","getState","graphiql","get","req","res","launchEditor","query","fileName","lineNumber","end","static","__dirname","noInfo","quiet","publicPath","output","proxy","config","prefix","url","proxiedUrl","originalUrl","pipe","request","next","sendFile","decodeURIComponent","parsedPath","parsePath","extname","startsWith","status","server","Server","io","on","socket","join","listener","listen","host","code","open","address","watchGlobs","map","chokidar","watch","to","emit","startServer","rl","copyStaticDirectory","setTimeout","rlInterface","createInterface","input","process","stdin","stdout","exit","module","exports","detect","parseInt","_port","question","answer","length","match"],"mappings":"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","file":"develop.js","sourcesContent":["/* @flow */\n\nconst chokidar = require(`chokidar`)\nconst express = require(`express`)\nconst graphqlHTTP = require(`express-graphql`)\nconst parsePath = require(`parse-filepath`)\nconst request = require(`request`)\nconst rl = require(`readline`)\nconst webpack = require(`webpack`)\nconst webpackConfig = require(`../utils/webpack.config`)\nconst bootstrap = require(`../bootstrap`)\nconst { store } = require(`../redux`)\nconst copyStaticDirectory = require(`../utils/copy-static-directory`)\nconst developHtml = require(`./develop-html`)\nconst { withBasePath } = require(`../utils/path`)\nconst report = require(`gatsby-cli/lib/reporter`)\nconst launchEditor = require(`react-dev-utils/launchEditor`)\n\n// Watch the static directory and copy files to public as they're added or\n// changed. Wait 10 seconds so copying doesn't interfer with the regular\n// bootstrap.\nsetTimeout(() => {\n  copyStaticDirectory()\n}, 10000)\n\nconst rlInterface = rl.createInterface({\n  input: process.stdin,\n  output: process.stdout,\n})\n\n// Quit immediately on hearing ctrl-c\nrlInterface.on(`SIGINT`, () => {\n  process.exit()\n})\n\nasync function startServer(program) {\n  const directory = program.directory\n  const directoryPath = withBasePath(directory)\n  const createIndexHtml = () =>\n    developHtml(program).catch(err => {\n      if (err.name !== `WebpackError`) {\n        report.panic(err)\n        return\n      }\n      report.panic(\n        report.stripIndent`\n          There was an error compiling the html.js component for the development server.\n\n          See our docs page on debugging HTML builds for help https://goo.gl/yL9lND\n        `,\n        err\n      )\n    })\n\n  // Start bootstrap process.\n  await bootstrap(program)\n\n  await createIndexHtml()\n\n  const compilerConfig = await webpackConfig(\n    program,\n    directory,\n    `develop`,\n    program.port\n  )\n\n  const devConfig = compilerConfig.resolve()\n  const compiler = webpack(devConfig)\n\n  /**\n   * Set up the express app.\n   **/\n  const app = express()\n  app.use(\n    require(`webpack-hot-middleware`)(compiler, {\n      log: () => {},\n      path: `/__webpack_hmr`,\n      heartbeat: 10 * 1000,\n    })\n  )\n  app.use(\n    `/___graphql`,\n    graphqlHTTP({\n      schema: store.getState().schema,\n      graphiql: true,\n    })\n  )\n  app.get(`/__open-stack-frame-in-editor`, (req, res) => {\n    launchEditor(req.query.fileName, req.query.lineNumber)\n    res.end()\n  })\n\n  app.use(express.static(__dirname + `/public`))\n\n  app.use(\n    require(`webpack-dev-middleware`)(compiler, {\n      noInfo: true,\n      quiet: true,\n      publicPath: devConfig.output.publicPath,\n    })\n  )\n\n  // Set up API proxy.\n  const { proxy } = store.getState().config\n  if (proxy) {\n    const { prefix, url } = proxy\n    app.use(`${prefix}/*`, (req, res) => {\n      const proxiedUrl = url + req.originalUrl\n      req.pipe(request(proxiedUrl)).pipe(res)\n    })\n  }\n\n  // Check if the file exists in the public folder.\n  app.get(`*`, (req, res, next) => {\n    // Load file but ignore errors.\n    res.sendFile(\n      directoryPath(`/public/${decodeURIComponent(req.url)}`),\n      err => {\n        // No err so a file was sent successfully.\n        if (!err || !err.path) {\n          next()\n        } else if (err) {\n          // There was an error. Let's check if the error was because it\n          // couldn't find an HTML file. We ignore these as we want to serve\n          // all HTML from our single empty SSR html file.\n          const parsedPath = parsePath(err.path)\n          if (\n            parsedPath.extname === `` ||\n            parsedPath.extname.startsWith(`.html`)\n          ) {\n            next()\n          } else {\n            res.status(404).end()\n          }\n        }\n      }\n    )\n  })\n\n  // Render an HTML page and serve it.\n  app.use((req, res, next) => {\n    const parsedPath = parsePath(req.originalUrl)\n    if (parsedPath.extname === `` || parsedPath.extname.startsWith(`.html`)) {\n      res.sendFile(directoryPath(`public/index.html`), err => {\n        if (err) {\n          res.status(500).end()\n        }\n      })\n    } else {\n      next()\n    }\n  })\n\n  /**\n   * Set up the HTTP server and socket.io.\n   **/\n\n  const server = require(`http`).Server(app)\n  const io = require(`socket.io`)(server)\n\n  io.on(`connection`, socket => {\n    socket.join(`clients`)\n  })\n\n  const listener = server.listen(program.port, program.host, err => {\n    if (err) {\n      if (err.code === `EADDRINUSE`) {\n        // eslint-disable-next-line max-len\n        report.panic(\n          `Unable to start Gatsby on port ${program.port} as there's already a process listing on that port.`\n        )\n        return\n      }\n\n      report.panic(`There was a problem starting the development server`, err)\n    }\n\n    if (program.open) {\n      const host =\n        listener.address().address === `127.0.0.1`\n          ? `localhost`\n          : listener.address().address\n      require(`opn`)(`http://${host}:${listener.address().port}`)\n    }\n  })\n\n  // Register watcher that rebuilds index.html every time html.js changes.\n  const watchGlobs = [`src/html.js`, `plugins/**/gatsby-ssr.js`].map(path =>\n    directoryPath(path)\n  )\n\n  chokidar.watch(watchGlobs).on(`change`, async () => {\n    await createIndexHtml()\n    io.to(`clients`).emit(`reload`)\n  })\n}\n\nmodule.exports = (program: any) => {\n  const detect = require(`detect-port`)\n  const port =\n    typeof program.port === `string` ? parseInt(program.port, 10) : program.port\n\n  detect(port, (err, _port) => {\n    if (err) {\n      report.panic(err)\n    }\n\n    if (port !== _port) {\n      // eslint-disable-next-line max-len\n      const question = `Something is already running at port ${port} \\nWould you like to run the app at another port instead? [Y/n] `\n\n      return rlInterface.question(question, answer => {\n        if (answer.length === 0 || answer.match(/^yes|y$/i)) {\n          program.port = _port // eslint-disable-line no-param-reassign\n        }\n\n        return startServer(program)\n      })\n    }\n\n    return startServer(program)\n  })\n}\n"]}